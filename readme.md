# Inline Summary — a SillyTavern Extension

## AI Disclaimer
The code for this extension was AI-generated, then manually edited and refactored so the final result is around 65% AI.<br>
I'm a C++ programmer, and this is my first time touching JavaScript, hence the vibecoding.<br>

## What does it do?
This is a simple Summary/Memory extension. It allows you to select a range of messages in chat and summarise them using an LLM or manually. It then replaces the selected range with a summary message.<br>
The original messages are stored away and hidden, but can be restored at any time.<br>

## Usage
#### Making a new Summary
Select a **Start** ( <img src="https://raw.githubusercontent.com/FortAwesome/Font-Awesome/7.x/svgs/solid/arrow-right-from-bracket.svg" width="12" height="12"> ) and an **End** ( <img src="https://raw.githubusercontent.com/FortAwesome/Font-Awesome/7.x/svgs/solid/arrow-right-to-bracket.svg" width="12" height="12"> ) message using the two Message Action buttons.<br>
![Alt text](images/usage1.png)<br>
![Alt text](images/usage2.png)<br>
Then the options for **AI Summary** ( <img src="https://raw.githubusercontent.com/FortAwesome/Font-Awesome/7.x/svgs/solid/robot.svg" width="12" height="12"> ), **Manual Summary** ( <img src="https://raw.githubusercontent.com/FortAwesome/Font-Awesome/7.x/svgs/solid/user-tag.svg" width="12" height="12"> ), and **Clear Range** ( <img src="https://raw.githubusercontent.com/FortAwesome/Font-Awesome/7.x/svgs/solid/broom.svg" width="12" height="12"> ) will appear.<br>
![Alt text](images/usage3.png)<br>
Click the **AI Summary** button and wait for the AI to finish generating.<br>
Alternatively click the **Manual Summary** button, then edit the inserted message and write a manual summary.<br>

#### Existing Summary
Summary messages will contain an expandable header which contains the original messages. Click anywhere on the header (except the buttons) to expand it.<br>
![Alt text](images/usage4.png)<br>
The **Restore Original and Delete Summary** ( <img src="https://raw.githubusercontent.com/FortAwesome/Font-Awesome/7.x/svgs/solid/file-arrow-up.svg" width="12" height="12"> ) button will detele the summary and restore the original messages.<br>
The **Re-Summarise (AI)** ( <img src="https://raw.githubusercontent.com/FortAwesome/Font-Awesome/7.x/svgs/solid/robot.svg" width="12" height="12"> ) will regenerate a new summary using the stored original messages.

## How does it work?
When a range is selected, the extension creates a new empty summary message and inserts it into the chat.<br>
The selected messages are stored in the `extra` data field of the new summary message.<br>
A summary prompt is generated by taking the main summary prompt and adding a specified number of earlier messages for context (or the entire history if the setting is `-1`). The context is wrapped with Start/End markers as defined in the settings.<br>
A mid-prompt is appended (also defined in the settings).<br>
The messages to be summarised are then added, also wrapped in Start/End markers.<br>
A end-prompt is appended (also defined in the settings).<br>
This complete prompt is sent to the LLM using the current connection profile or a specific profile if the option is enabled.<br>
Once the LLM is done, the contents of the summary message are replaced with the response. The chat is saved and refreshed.<br>
When the **Restore** button is pressed, the summary message is deleted and the original messages are reinserted into the chat.<br>

## FAQ

_**Can I edit the summary?**_<br>
Yes! They behave like any other message.

_**Can summary messages be summarised?**_<br>
Yes. Nested summaries are supported. When summarising a summary message, the summary text will be used, **not** the original messages

_**What happens during chat exports?**_<br>
If exported as JSON, the original messages will be in the file.<br>
When exported as plain text, only the summary messages will be exported.

_**Are swipes supported on summary messages?**_<br>
No. It shouldn’t break, but swipes will behave like regular message swipes without any awareness of the summary or the original messages attached to it.

_**Is it compatible with extension X?**_<br>
No idea. This extension directly manipulates chat and stores/restores messages without altering them. As long as other extensions are okay with that, it *should* be compatible — but no promises.

_**Can I select a specific Connection Profile/Chat Completion Preset for the summary?**_<br>
Yes. Since v1.0.2<br>
⚠ Warning: Any unsaved changes to `Connection Profile` or `Chat Completion Preset` or `AI Reponse Template` will be lost during profile change.

_**Has anyone actually asked these questions?**_<br>
Yes, the Connection Profile one.

## Known Incompatibilities

_**Chat Style - Document**_<br>
This specific style hides the Message Actions buttons from older messages, which also removes the buttons added by this extension. Bubbles and Flat styles do work.<br>
_**Text Completion**_<br>
In text completion mode `Connection Profile` or `Chat Completion Preset` are not supported and might create odd results.<br>
`Chat Completion Preset` option shows a list of numbers when Text Completion mode is active. Swapping to chat completion and refreshing the page should fix it.<br>

## Changelog

#### v1.0.11
Fixed `Original Messages` not appearing on chat messages when after they were hidden by the visible message limit.<br>
Added `/ils-sumarise` command. Usage: ``/ils-sumarise x y` or `/ils-sumarise manual=[true|false] x y` where x and y are start and stop message indices; `manual` mode inserts an placeholder summary message instead of using LLM.<br>
Changed error messages to use toast popups.

### Previous Changes
See `changelog.md`
